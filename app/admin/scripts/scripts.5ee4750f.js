"use strict";angular.module("appApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","btford.socket-io"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/desktop.html",controller:"DesktopCtrl"}).when("/monitor",{templateUrl:"views/monitor.html",controller:"MonitorCtrl"}).when("/desktop",{templateUrl:"views/desktop.html",controller:"DesktopCtrl"}).when("/mobile",{templateUrl:"views/mobile.html",controller:"MobileCtrl"}).otherwise({redirectTo:"/"})}]).run(["upgradeCheck","$window",function(a,b){a.monitor(function(){b.location.reload()})}]).run(["refresh","$window",function(a){a.refreshMonitor()}]),angular.module("appApp").service("socketIo",["socketFactory","server",function(a,b){if(b.usesSocketIo){var c=b.host,d=window.io,e=a({ioSocket:d.connect(c)});return e.onConnect=function(a){a()},e.channels={onNewGuest:"new-guest",sendCareGuest:"care-guest",onGuestCared:"guest-cared"},e}}]),angular.module("appApp").filter("timeCount",function(){return function(a){return a=Math.floor(a),10>=a?"recien llegado":60>a?"Esperando hace "+a+" segundos":1===Math.floor(a/60)?"Esperando hace un minuto":Math.floor(a/60)<60?"Esperando hace "+Math.floor(a/60)+" minutos":1===Math.floor(a/3600)?"Esperando hace una hora":"Esperando hace "+Math.floor(a/3600)+" horas"}}),angular.module("appApp").controller("SignInCtrl",["$scope","user","googleClientId",function(a,b,c){function d(b){b.access_token?(a.user.signedIn=!0,console.log(b),a.getUserInfo(),a.$apply()):b.error&&(a.user.signedIn=!1,console.log(b.error))}function e(){f.signin.render("signInButton",{callback:d,clientid:c,requestvisibleactions:"http://schemas.google.com/AddActivity",scope:"https://www.googleapis.com/auth/plus.login https://www.googleapis.com/auth/userinfo.email",cookiepolicy:"single_host_origin"})}var f=window.gapi,g=window._;a.user=b,a.getUserInfo=function(){f.client.request({path:"/plus/v1/people/me",method:"GET",callback:function(b){console.log(b),a.user.data=b,a.$apply()}})},a.signOut=function(){f.auth.signOut(),a.user.signedIn=!1},a.user.signedIn||g.delay(e,1e3)}]),angular.module("appApp").service("user",function(){var a={signedIn:!1,info:{}};return a}),angular.module("appApp").service("socketJs",["$location","server","$window","$timeout",function(a,b,c,d){if(!b.usesSocketIo){var e=a.search(),f="default";console.log(a.search()),e.channel&&(f=e.channel);var g,h,i,j,k=window.SockJS,l=window.Stomp,m=!1;return g="http://"+b.host+"/ws",h=new k(g),i=l.over(h),i.connect({},function(a){console.log("Connected: "+a),m=!0,(i.on||i.emit)&&console.error("We can't override the stomp's methods"),i.on||(i.on=i.subscribe),i.emit||(i.emit=function(a,b){i.send(a,{},JSON.stringify(b))}),h.onclose=function(){console.log("The socket was closed"),c.location.reload()},j&&j()}),d(function(){m||c.location.reload()},15e3),i.onConnect=function(a){m?a():j=a},i.channels={onNewGuest:"/topic/"+f+"/new-guest",sendCareGuest:"/app/care-guest",onGuestCared:"/topic/"+f+"/care-guest",channelName:f},i}}]),angular.module("appApp").controller("MonitorCtrl",["$scope","guests","$rootScope","notification",function(a,b,c,d){function e(){d.play("incoming-guest")}var f;a.guests=b,b.start(),f=c.$on("newGuest",e),a.$on("$destroy",function(){f()})}]),angular.module("appApp").controller("DesktopCtrl",["$scope","guests","user","$rootScope","notification",function(a,b,c,d,e){function f(a,b){e.play("incoming-guest"),e.popup({title:"Recepcionista Virtual",body:b.data.type+" - "+b.data.name,image:"images/bell.png"})}var g;a.user=c,a.guests=b,b.start(),g=d.$on("newGuest",f),a.$on("$destroy",function(){g()})}]),angular.module("appApp").controller("MobileCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("appApp").service("guests",["socket","user","$http","$location","server","notification","$rootScope",function(a,b,c,d,e,f,g){function h(a){var b=(new Date).getTime();return Math.floor((b-a)/1e3)}function i(){l.each(m.list,function(a){a.secondsLeft=h(a.time),a.secondsLeft<120?a.timeStatusColor="green":a.secondsLeft<600?a.timeStatusColor="yellow":a.timeStatusColor="red",a.secondsLeft>=600&&!a.cared&&a.alerted<=5&&a.secondsLeft%20===0&&(console.log(a.id,a.secondsLeft,!a.cared,a.alerted),a.alerted+=1,f.play("default"))}),g.$apply(),l.delay(i,1e3)}function j(a){if(a.body)try{a=JSON.parse(a.body)}catch(b){return console.error(b)}a.data.mode&&(a.data.type=o[a.data.mode]),a.data.typeName=a.data.type,a.alerted=0,a.cared=!1,a.caredTime=0,a.secondsLeft=h(a.time),g.$broadcast("newGuest",a),m.list.push(a)}function k(a){var b;if(a.body)try{a=JSON.parse(a.body)}catch(c){return console.error(c)}b=l.findWhere(m.list,{id:a.id}),b.cared=!0,b.caredTime=a.time,b.caredBy=a.caredBy}var l=window._,m={list:[]},n=!1,o={1:"Recruiting",2:"Cliente",3:"Primer dÃ­a",4:"Delivery"},p=a.channels;return console.log(p),m.start=function(){a.onConnect(function(){n||(n=!0,a.on(p.onNewGuest,j),a.on(p.onGuestCared,k),i())})},m.careGuest=function(c){var d={id:c,time:(new Date).getTime(),caredBy:{name:b.data.displayName,img:b.data.image.url,email:b.data.emails[0].value},channel:p.channelName};a.emit(p.sendCareGuest,d),console.log(JSON.stringify(d))},m.fetchGuestList=function(){c.get("http://"+e.host+"/api/guests-today").success(function(a){l.isArray(a)?m.list=l.map(a,function(a){var b={id:a.id,time:a.time||a.arrivalTime};return a.mode&&o[a.mode]&&(a.type=o[a.mode]),b.data={type:a.type,name:a.name},b.data.typeName=b.data.type,a.caredBy?(b.cared=!0,b.caredTime=a.caredBy.time||a.careTime,b.caredBy=a.caredBy):b.cared=!1,b.alerted=0,b.secondsLeft=h(b.time),b}):console.error(new Error("The fetched guest list it is not an array"))}).error(function(){console.error(new Error("Error trying to get the guest list"))})},m.fetchGuestList(),m}]),angular.module("appApp").factory("googleClientId",["$location",function(a){var b={"localhost:9000":"97259507605-l1l7542h9uvsj47eitufv0trihlus1us.apps.googleusercontent.com","http://recvir.diegofernandez.svc.tutum.io":"97259507605-l1l7542h9uvsj47eitufv0trihlus1us.apps.googleusercontent.com","172.17.201.156:80":"97259507605-l1l7542h9uvsj47eitufv0trihlus1us.apps.googleusercontent.com","172.17.201.152:80":"97259507605-l1l7542h9uvsj47eitufv0trihlus1us.apps.googleusercontent.com","172.17.195.152:80":"97259507605-5id2u2sabde4vvr5de3cb4ue0lbgjhhj.apps.googleusercontent.com","receptionist-eze1.globallogic.com:80":"97259507605-5id2u2sabde4vvr5de3cb4ue0lbgjhhj.apps.googleusercontent.com"},c=a.host(),d=a.port(),e=c+":"+d,f=b[e];return f||console.error("There isn't a valid google client id for the current url ("+e+")"),f}]),angular.module("appApp").factory("server",["$location",function(a){var b=a.host()+"/vreceptionist/",c=!1;return console.log(b),{host:b,usesSocketIo:c}}]),angular.module("appApp").service("socket",["socketIo","socketJs","server",function(a,b,c){return c.usesSocketIo?a:b}]),angular.module("appApp").service("notification",["$window",function(a){function b(a){h=a}function c(){return h}var d,e,f=a.buzz,g=a._,h=!1,i=a.Notification;return d=g.throttle(function(a){if(!c()){var b=new f.sound("sounds/"+a,{formats:["mp3"]});b.play()}},5e3),e=g.throttle(function(a,b){if(i){var c;i.requestPermission(function(){}),c=new i(a.title,{body:a.body,icon:a.image}),c.onclick=b}},2e3),{play:d,mute:b,isMuted:c,popup:e}}]),angular.module("appApp").controller("NotificationsCtrl",["$scope","notification",function(a,b){a.muted=b.isMuted(),a.switchMute=function(){a.muted=!a.muted,b.mute(a.muted)}}]),angular.module("appApp").service("upgradeCheck",["$http","$interval",function(a,b){function c(b){a.get("version.txt?v="+Date.now()).success(function(a){b(a)}).error(function(){console.error("Error trying to fetch version"),b(null)})}function d(a){var d;c(function(e){d=e,b(function(){c(function(b){d!==b&&(d=b,a(b))})},12e4)})}return{getVersion:c,monitor:d}}]),angular.module("appApp").service("refresh",["$http","$interval","$window",function(a,b,c){function d(){b(function(){console.log("Refreshing tv monitor"),c.location.reload()},e())}function e(){var a=new Date;a.setDate(a.getDate()+1),a.setHours(1),a.setMinutes(0),a.setSeconds(0),a.setMilliseconds(0);var b=a.getTime()-(new Date).getTime();return console.log("Milliseconds to refresh time: "+b),b}return{refreshMonitor:d}}]);
